<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>ç¬¬4è®² dplyræ•°æ®å¤„ç†</title>
    <meta charset="utf-8" />
    <meta name="author" content=" æ›¾æ°¸è‰º" />
    <meta name="date" content="2023-10-13" />
    <script src="../libs/header-attrs/header-attrs.js"></script>
    <link href="../libs/tile-view/tile-view.css" rel="stylesheet" />
    <script src="../libs/tile-view/tile-view.js"></script>
    <link href="../libs/tachyons/tachyons.min.css" rel="stylesheet" />
    <link href="../libs/panelset/panelset.css" rel="stylesheet" />
    <script src="../libs/panelset/panelset.js"></script>
    <script src="../libs/freezeframe/freezeframe.min.js"></script>
    <script src="../libs/xaringanExtra-freezeframe/freezeframe-init.js"></script>
    <script id="xaringanExtra-freezeframe-options" type="application/json">{"selector":"img[src$=\"gif\"]","trigger":"click","overlay":false,"responsive":false,"warnings":true}</script>
    <script type="application/json" id="xaringanExtra-editable-docid">{"id":"x054fe7f2c1d4a89bbacc6dae102256a","expires":7}</script>
    <script src="../libs/himalaya/himalaya.js"></script>
    <script src="../libs/js-cookie/js.cookie.js"></script>
    <link href="../libs/editable/editable.css" rel="stylesheet" />
    <script src="../libs/editable/editable.js"></script>
    <link href="../libs/xaringanExtra-extra-styles/xaringanExtra-extra-styles.css" rel="stylesheet" />
    <link href="../libs/animate.css/animate.xaringan.css" rel="stylesheet" />
    <script src="../libs/clipboard/clipboard.min.js"></script>
    <link href="../libs/xaringanExtra-clipboard/xaringanExtra-clipboard.css" rel="stylesheet" />
    <script src="../libs/xaringanExtra-clipboard/xaringanExtra-clipboard.js"></script>
    <script>window.xaringanExtraClipboard(null, {"button":"<i class=\"fa fa-copy\"><\/i>","success":"<i class=\"fa fa-check\" style=\"color: #90BE6D\"><\/i>","error":"<i class=\"fa fa-times-circle\" style=\"color: #F94144\"><\/i>"})</script>
    <link href="../libs/font-awesome/css/all.min.css" rel="stylesheet" />
    <link href="../libs/font-awesome/css/v4-shims.min.css" rel="stylesheet" />
    <link href="../libs/countdown/countdown.css" rel="stylesheet" />
    <script src="../libs/countdown/countdown.js"></script>
    <script src="../libs/htmlwidgets/htmlwidgets.js"></script>
    <link href="../libs/datatables-css/datatables-crosstalk.css" rel="stylesheet" />
    <script src="../libs/datatables-binding/datatables.js"></script>
    <script src="../libs/jquery/jquery-3.6.0.min.js"></script>
    <link href="../libs/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
    <link href="../libs/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
    <script src="../libs/dt-core/js/jquery.dataTables.min.js"></script>
    <link href="../libs/crosstalk/css/crosstalk.min.css" rel="stylesheet" />
    <script src="../libs/crosstalk/js/crosstalk.min.js"></script>
    <link rel="stylesheet" href="../libs/zen-styles-v2.3-rev.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# é‡åŒ–é‡‘èä¸é‡‘èç¼–ç¨‹
]
.subtitle[
## L4 <code>dplyr</code><sup>.font80[1.1.3]</sup> æ•°æ®å¤„ç†
]
.author[
### <br>æ›¾æ°¸è‰º
]
.institute[
### å¦é—¨å¤§å­¦ç®¡ç†å­¦é™¢
]
.date[
### <br>2023-10-13
]

---

class: middle, hide_logo
background-image: url(imgs/logo-dplyr.png)
background-size: 25%
background-position: 19% 30%



<div>
<style type="text/css">.xaringan-extra-logo {
width: 50px;
height: 50px;
z-index: 0;
background-image: url(imgs/logo-sm.png);
background-size: contain;
background-repeat: no-repeat;
position: absolute;
top:0.5em;right:0.5em;
}
</style>
<script>(function () {
  let tries = 0
  function addLogo () {
    if (typeof slideshow === 'undefined') {
      tries += 1
      if (tries < 10) {
        setTimeout(addLogo, 100)
      }
    } else {
      document.querySelectorAll('.remark-slide-content:not(.title-slide):not(.inverse):not(.hide_logo)')
        .forEach(function (slide) {
          const logo = document.createElement('a')
          logo.classList = 'xaringan-extra-logo'
          logo.href = 'https://qfwr2022.netlify.app'
          slide.appendChild(logo)
        })
    }
  }
  document.addEventListener('DOMContentLoaded', addLogo)
})()</script>
</div>

.pull-left.font120.bold.center[
&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;
_A Grammar of &lt;br&gt;Data Manipulation_
&lt;br&gt;&lt;br&gt;
]

--
 
.pull-right.font150.bold[

1. æ ·æœ¬å¤„ç†

2. å˜é‡å¤„ç†

3. æ±‡æ€»

4. åˆ†ç»„å’Œè¡Œå¼å¤„ç†

5. ç”¨ `%&gt;%` è¿æ¥å¤šä¸ªæ“ä½œ

6. åˆå¹¶å¤šä¸ªæ•°æ®é›†

7. æ“ä½œæ•°æ®åº“å’Œ `data.table`

]


---


```r
library(tidyverse)
library(nycflights13)

data(package = "nycflights13")
# åŒ…å«airlinesã€airportsã€flightsã€planesã€weatherç­‰5ä¸ªæ•°æ®é›†
```

--


```r
flights  # just print() it
```

```
#&gt; # A tibble: 336,776 Ã— 19
#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time arr_delay
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;
#&gt; 1  2013     1     1      517            515         2      830            819        11
#&gt; 2  2013     1     1      533            529         4      850            830        20
#&gt; 3  2013     1     1      542            540         2      923            850        33
#&gt; # â„¹ 336,773 more rows
#&gt; # â„¹ 10 more variables: carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;,
#&gt; #   dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;,
#&gt; #   time_hour &lt;dttm&gt;
```
--

&gt; * `A tibble: 336,776 x 19`
&gt; * `&lt;int&gt;` | `&lt;dbl&gt;` | `&lt;chr&gt;` | `&lt;dttm&gt;` | `&lt;lgl&gt;` | `&lt;fctr&gt;` | `&lt;date&gt;` åˆ†åˆ«è¡¨ç¤ºå˜é‡ä¸º integer | double | character | date-time | logical | factor | date ç±»å‹çš„å‘é‡

--


```r
?flights  # æ‰“å¼€flightsæ•°æ®é›†çš„å¸®åŠ©æ–‡æ¡£ä»¥è¿›ä¸€æ­¥äº†è§£æ•°æ®é›†ï¼Œå¦‚å˜é‡çš„å®šä¹‰
```

---


```r
glimpse(flights)  # æ•°æ®ä¸€ç¥
```

```
#&gt; Rows: 336,776
#&gt; Columns: 19
#&gt; $ year           &lt;int&gt; 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013,â€¦
#&gt; $ month          &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,â€¦
#&gt; $ day            &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,â€¦
#&gt; $ dep_time       &lt;int&gt; 517, 533, 542, 544, 554, 554, 555, 557, 557, 558, 558, 558, 558, â€¦
#&gt; $ sched_dep_time &lt;int&gt; 515, 529, 540, 545, 600, 558, 600, 600, 600, 600, 600, 600, 600, â€¦
#&gt; $ dep_delay      &lt;dbl&gt; 2, 4, 2, -1, -6, -4, -5, -3, -3, -2, -2, -2, -2, -2, -1, 0, -1, 0â€¦
#&gt; $ arr_time       &lt;int&gt; 830, 850, 923, 1004, 812, 740, 913, 709, 838, 753, 849, 853, 924,â€¦
#&gt; $ sched_arr_time &lt;int&gt; 819, 830, 850, 1022, 837, 728, 854, 723, 846, 745, 851, 856, 917,â€¦
#&gt; $ arr_delay      &lt;dbl&gt; 11, 20, 33, -18, -25, 12, 19, -14, -8, 8, -2, -3, 7, -14, 31, -4,â€¦
#&gt; $ carrier        &lt;chr&gt; "UA", "UA", "AA", "B6", "DL", "UA", "B6", "EV", "B6", "AA", "B6",â€¦
#&gt; $ flight         &lt;int&gt; 1545, 1714, 1141, 725, 461, 1696, 507, 5708, 79, 301, 49, 71, 194â€¦
#&gt; $ tailnum        &lt;chr&gt; "N14228", "N24211", "N619AA", "N804JB", "N668DN", "N39463", "N516â€¦
#&gt; $ origin         &lt;chr&gt; "EWR", "LGA", "JFK", "JFK", "LGA", "EWR", "EWR", "LGA", "JFK", "Lâ€¦
#&gt; $ dest           &lt;chr&gt; "IAH", "IAH", "MIA", "BQN", "ATL", "ORD", "FLL", "IAD", "MCO", "Oâ€¦
#&gt; $ air_time       &lt;dbl&gt; 227, 227, 160, 183, 116, 150, 158, 53, 140, 138, 149, 158, 345, 3â€¦
#&gt; $ distance       &lt;dbl&gt; 1400, 1416, 1089, 1576, 762, 719, 1065, 229, 944, 733, 1028, 1005â€¦
#&gt; $ hour           &lt;dbl&gt; 5, 5, 5, 5, 6, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 6, 6, 6, 6, 6, 6,â€¦
#&gt; $ minute         &lt;dbl&gt; 15, 29, 40, 45, 0, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 0, 0, 0, 0,â€¦
#&gt; $ time_hour      &lt;dttm&gt; 2013-01-01 05:00:00, 2013-01-01 05:00:00, 2013-01-01 05:00:00, 2â€¦
```
--


```r
View(flights)     # åœ¨ RStudio æ•°æ®æµè§ˆå™¨ä¸­æ‰“å¼€æ•°æ®é›†
# tibble::view() è°ƒç”¨ utils::View() å¹¶ä¸å¯è§åœ°è¿”å›åŸæ•°æ®é›†ï¼Œä¾¿äº %&gt;% æ“ä½œï¼Œä½†é€Ÿåº¦å¥½åƒæ…¢å¾ˆå¤š
```

---
layout: false
class: hide_logo

## .font150[ğŸ¤”] æƒ³æƒ³ 

&lt;style type="text/css"&gt;
#special_timer.running {
  background-color: black;
  background-image: url(imgs/bg-stars.gif);
}
#special_timer.finished {
  background-color: black;
  background-image: url(imgs/bg-sqfw.gif);
  background-size: cover;
}
#special_timer.running .countdown-digits {
  color: #fdf6e3;
}
#special_timer.finished .countdown-digits {
  color: #fdf6e3;
}
&lt;/style&gt;

<div class="countdown" id="special_timer" data-warn-when="10" data-update-every="1" tabindex="0" style="top:0;right:0;font-size:2em;">
<div class="countdown-controls"><button class="countdown-bump-down">&minus;</button><button class="countdown-bump-up">&plus;</button></div>
<code class="countdown-time"><span class="countdown-digits minutes">05</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>


.font150[å¯¹äºå¦‚ä¸‹ç”±**è¡Œ**ï¼ˆæ ·æœ¬ï¼‰å’Œ**åˆ—**ï¼ˆå˜é‡ï¼‰æ„æˆçš„æ•°æ®é›† / æ•°æ®è¡¨æˆ‘ä»¬å¯ä»¥è¿›è¡Œå“ªäº›æ–¹é¢çš„æ“ä½œå‘¢ï¼Ÿ]

.font80[
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-cfe3582f386358c952a9" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-cfe3582f386358c952a9">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20"],[2013,2013,2013,2013,2013,2013,2013,2013,2013,2013,2013,2013,2013,2013,2013,2013,2013,2013,2013,2013],[1,1,1,2,3,4,4,6,6,6,6,7,7,8,9,9,10,11,11,12],[7,13,22,6,9,5,27,12,14,22,26,1,23,12,24,29,10,11,24,17],[831,828,1915,2153,1708,1813,605,605,2110,1722,455,756,2143,822,705,1250,1259,1629,2000,1457],[-3,4,0,-6,-2,-2,-1,-10,10,22,-5,-4,96,-7,0,-8,19,-6,20,-2],[-21,-17,2,-22,3,-16,-24,-36,61,1,-19,10,95,3,14,-10,19,-29,17,25],[138,140,129,46,223,96,141,68,357,68,75,59,199,72,200,35,120,121,151,93],["UA","UA","9E","EV","AA","DL","UA","US","DL","EV","US","US","UA","MQ","AA","B6","WN","MQ","B6","US"],["EWR","EWR","JFK","EWR","JFK","EWR","EWR","EWR","JFK","EWR","EWR","LGA","EWR","JFK","LGA","JFK","LGA","JFK","LGA","EWR"],["MCO","MCO","ORD","BTV","AUS","ATL","FLL","CLT","LAX","RDU","CLT","DCA","SJU","RDU","DFW","BOS","STL","BNA","FLL","CLT"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>year<\/th>\n      <th>month<\/th>\n      <th>day<\/th>\n      <th>dep_time<\/th>\n      <th>dep_delay<\/th>\n      <th>arr_delay<\/th>\n      <th>air_time<\/th>\n      <th>carrier<\/th>\n      <th>origin<\/th>\n      <th>dest<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":8,"dom":"tip","columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[8,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
]

---
class: inverse, center, middle

# 1. æ ·æœ¬å¤„ç†

.font150[(manipulate cases)]

---
layout: true

### &gt;&gt; æ ·æœ¬ç­›é€‰ï¼š`filter()`

---

.full-width[.content-box-blue.bold.font120[`filter(.data, ...)`ï¼šæå–æ•°æ®é›† `.data` ä¸­å˜é‡å–å€¼æ»¡è¶³è®¾å®šæ¡ä»¶çš„æ ·æœ¬]]

--


```r
filter(flights, month == 1, day == 1)
*# æ³¨æ„ï¼šæ¡ä»¶è¡¨è¾¾å¼ä¸­çš„æ˜¯ ==ï¼Œè€Œä¸æ˜¯ =
```

```
#&gt; # A tibble: 842 Ã— 19
#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time arr_delay
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;
#&gt; 1  2013     1     1      517            515         2      830            819        11
#&gt; 2  2013     1     1      533            529         4      850            830        20
#&gt; 3  2013     1     1      542            540         2      923            850        33
#&gt; # â„¹ 839 more rows
#&gt; # â„¹ 10 more variables: carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;,
#&gt; #   dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;,
#&gt; #   time_hour &lt;dttm&gt;
```

--


```r
# åœ¨ R åŸºç¡€åŒ…ä¸­çš„å®ç°æ–¹æ³•
flights[flights$month == 1 &amp; flights$day == 1, ]
subset(flights, month == 1 &amp; day == 1)
```


```r
flights[month == 1 &amp; day == 1, ]  # æ³¨æ„ï¼šè¿™æ ·å†™æ˜¯é”™æ»´
```

```
#&gt; Error in month == 1: comparison (==) is possible only for atomic and list types
```

---

.full-width[.content-box-blue.bold.font120.note[dplyr åŒ…ä¸­çš„å‡½æ•°ï¼ˆå¦‚ `filter()` ï¼‰å¹¶ä¸ä¼šç›´æ¥ä¿®æ”¹è¾“å…¥æ•°æ®é›† `.data`]]

--

.full-width[.content-box-blue.bold.font120.warning[ä½ å¿…é¡»è‡ªè¡Œå­˜å‚¨ä¿®æ”¹åçš„æ•°æ®é›† ğŸ’¾]]


```r
dec25 &lt;- filter(flights, month == 12, day == 25)
dec25
```

```
*#&gt; # A tibble: 719 Ã— 19
#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time arr_delay
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;
#&gt; 1  2013    12    25      456            500        -4      649            651        -2
#&gt; 2  2013    12    25      524            515         9      805            814        -9
#&gt; 3  2013    12    25      542            540         2      832            850       -18
#&gt; # â„¹ 716 more rows
#&gt; # â„¹ 10 more variables: carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;,
#&gt; #   dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;,
#&gt; #   time_hour &lt;dttm&gt;
```

```r
flights  # è¾“å…¥æ•°æ®é›†ä»ç„¶ä¿æŒä¸å˜
```

```
*#&gt; # A tibble: 336,776 Ã— 19
#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time arr_delay
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;
#&gt; 1  2013     1     1      517            515         2      830            819        11
#&gt; 2  2013     1     1      533            529         4      850            830        20
#&gt; 3  2013     1     1      542            540         2      923            850        33
#&gt; # â„¹ 336,773 more rows
#&gt; # â„¹ 10 more variables: carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;,
#&gt; #   dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;,
#&gt; #   time_hour &lt;dttm&gt;
```

---

.full-width[.content-box-blue.bold.font120.note[`filter()` ä¼šç”¨åˆ°çš„æ¯”è¾ƒè¿ç®—ç¬¦å’Œé€»è¾‘è¿ç®—ç¬¦]]

```r
  1. &lt;    &gt;     &lt;=    &gt;=    ==    !=          # ?Comparison
  
  2. &amp;    |     !     xor()                   # ?base::Logic
  
  3. å…¶å®ƒçš„å¦‚ï¼š%in%ã€is.na()ã€between()ã€near()ã€if_any()ã€if_all() ç­‰
```
--

.full-width[.content-box-blue.bold.font120.note[`filter()` é»˜è®¤ä»¥ `&amp;` çš„æ–¹å¼ç»„åˆå¤šä¸ªæ¡ä»¶å‚æ•°ï¼Œ...]]

--


```r
filter(flights, month &gt;= 11, day == 25)    # ç­‰æ•ˆäº
filter(flights, month &gt;= 11 &amp; day == 25)
```

--

.full-width[.content-box-blue.bold.font120.note[... å…¶å®ƒé€»è¾‘ç»„åˆæ–¹å¼ï¼ˆå¦‚`|`ï¼‰åˆ™éœ€è‡ªè¡Œè®¾å®š]]

---
layout: false
class: hide_logo

## .font150[ğŸ¤”] æƒ³æƒ³ 

&lt;style type="text/css"&gt;
#special_timer.running {
  background-color: black;
  background-image: url(imgs/bg-stars.gif);
}
#special_timer.finished {
  background-color: black;
  background-image: url(imgs/bg-sqfw.gif);
  background-size: cover;
}
#special_timer.running .countdown-digits {
  color: #fdf6e3;
}
#special_timer.finished .countdown-digits {
  color: #fdf6e3;
}
&lt;/style&gt;

<div class="countdown" id="special_timer" data-warn-when="10" data-update-every="1" tabindex="0" style="top:0;right:0;font-size:2em;">
<div class="countdown-controls"><button class="countdown-bump-down">&minus;</button><button class="countdown-bump-up">&plus;</button></div>
<code class="countdown-time"><span class="countdown-digits minutes">05</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

.font150.bold.red[æ€æ ·æŒ‘å‡º11æœˆå’Œ12æœˆçš„èˆªç­æ ·æœ¬å‘¢ï¼Ÿ]

&lt;br&gt;
.panelset.font120[

.panel[.panel-name[å¤‡é€‰ä»£ç ]
.font110[

1) `filter(flights, month == 11 | 12)`

2) `filter(flights, month == (11 | 12))`

3) `filter(flights, month == 11 | month == 12)`

]
]

.panel[.panel-name[ç»“æœ1]
.code90[

```r
filter(flights, month == 11 | 12)
```

```
#&gt; # A tibble: 336,776 Ã— 19
#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time arr_delay
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;
#&gt; 1  2013     1     1      517            515         2      830            819        11
#&gt; 2  2013     1     1      533            529         4      850            830        20
#&gt; 3  2013     1     1      542            540         2      923            850        33
#&gt; # â„¹ 336,773 more rows
#&gt; # â„¹ 10 more variables: carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;,
#&gt; #   dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;,
#&gt; #   time_hour &lt;dttm&gt;
```
]
]

.panel[.panel-name[ç»“æœ2]
.code90[

```r
filter(flights, month == (11 | 12))
```

```
#&gt; # A tibble: 27,004 Ã— 19
#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time arr_delay
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;
#&gt; 1  2013     1     1      517            515         2      830            819        11
#&gt; 2  2013     1     1      533            529         4      850            830        20
#&gt; 3  2013     1     1      542            540         2      923            850        33
#&gt; # â„¹ 27,001 more rows
#&gt; # â„¹ 10 more variables: carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;,
#&gt; #   dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;,
#&gt; #   time_hour &lt;dttm&gt;
```
]
]

.panel[.panel-name[ç»“æœ3]
.code90[

```r
filter(flights, month == 11 | month == 12)
# filter(flights, month %in% c(11, 12))
```

```
#&gt; # A tibble: 55,403 Ã— 19
#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time arr_delay
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;
#&gt; 1  2013    11     1        5           2359         6      352            345         7
#&gt; 2  2013    11     1       35           2250       105      123           2356        87
#&gt; 3  2013    11     1      455            500        -5      641            651       -10
#&gt; # â„¹ 55,400 more rows
#&gt; # â„¹ 10 more variables: carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;,
#&gt; #   dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;,
#&gt; #   time_hour &lt;dttm&gt;
```
]
]

]

---
layout: true

### &gt;&gt; æ ·æœ¬ç­›é€‰ï¼šå…¶å®ƒå‡½æ•°

---

.font120[

* `slice(.data, ..., .by = NULL, .preserve = FALSE)`ï¼šæŒ‰ç…§æ•´æ•°å‘é‡ç»™å‡ºçš„ç´¢å¼•ä½ç½®é€‰æ‹©æ ·æœ¬ï¼Œæ­£ï¼ˆ.red[è´Ÿ]ï¼‰æ•´æ•°è¡¨ç¤ºä¿ç•™ï¼ˆ.red[ç§»é™¤]ï¼‰çš„æ ·æœ¬ï¼Œå¦‚ `slice(mtcars, 5:n())`

* `slice_head(.data, ..., n, prop, by = NULL)` å’Œ `slice_tail()` é€‰æ‹©æ•°æ®é›†å¼€å§‹ / ç»“å°¾çš„æ ·æœ¬ &amp;emsp;&amp;emsp; .red[vs. `utils::head() / tail()`?]

* `slice_sample(.data, ..., n, prop, by = NULL, weight_by = NULL, replace = FALSE)` éšæœºé€‰æ‹©æ ·æœ¬

* `slice_min(.data, order_by, ..., n, prop, by = NULL, with_ties = TRUE, na_rm = FALSE)` å’Œ `slice_max()` é€‰æ‹© `order_by` å‚æ•°æŒ‡å®šçš„å˜é‡æˆ–å…¶å‡½æ•°å–å€¼æœ€å¤§æˆ–æœ€å°çš„æ ·æœ¬

* `distinct(.data, ..., .keep_all = FALSE)`ï¼šç§»é™¤ï¼ˆæŒ‡å®šå˜é‡æˆ–å…¶å‡½æ•°ï¼‰å–å€¼é‡å¤çš„æ ·æœ¬ &amp;emsp;&amp;emsp; .red[â‰ˆ `base::unique()`]

]

.footnote.red[æ³¨: åœ¨ dplyr&lt;sup&gt;v1.0.0&lt;/sup&gt; ä¹‹å `top\_n()`ã€`top\_frac()`ã€`sample\_n()` å’Œ `sample\_frac()` ç­‰å‡½æ•°å·²è¢«ç›¸åº”çš„ `slice\_*()` å‡½æ•°æ‰€æ›¿ä»£]

---
layout: true

### &gt;&gt; æ ·æœ¬æ’åºï¼š`arrange()`

---

.full-width[.content-box-blue.bold.font120[`arrange(.data, ...)`ï¼šæ ¹æ®æŒ‡å®šå˜é‡çš„å–å€¼å¯¹æ•°æ®é›† `.data` çš„æ ·æœ¬æ’åº]]

--


```r
arrange(flights, year, month, day, dep_time)
```

```
#&gt; # A tibble: 336,776 Ã— 19
#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time arr_delay
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;
#&gt; 1  2013     1     1      517            515         2      830            819        11
#&gt; 2  2013     1     1      533            529         4      850            830        20
#&gt; 3  2013     1     1      542            540         2      923            850        33
#&gt; # â„¹ 336,773 more rows
#&gt; # â„¹ 10 more variables: carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;,
#&gt; #   dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;,
#&gt; #   time_hour &lt;dttm&gt;
```

--


```r
arrange(flights, desc(dep_delay))  # åŠ å…¥ desc() åå‘æ’åºï¼šä»å¤§åˆ°å°
```

```
#&gt; # A tibble: 336,776 Ã— 19
#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time arr_delay
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;
#&gt; 1  2013     1     9      641            900      1301     1242           1530      1272
#&gt; 2  2013     6    15     1432           1935      1137     1607           2120      1127
#&gt; 3  2013     1    10     1121           1635      1126     1239           1810      1109
#&gt; # â„¹ 336,773 more rows
#&gt; # â„¹ 10 more variables: carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;,
#&gt; #   dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;,
#&gt; #   time_hour &lt;dttm&gt;
```

---

.full-width[.content-box-blue.bold.font120.note[ä¸åƒ dplyr åŒ…ä¸­çš„å…¶å®ƒå‡½æ•°ï¼Œ`arrange(.data, ..., .by_group = FALSE)` ä¼šå¿½ç•¥æ•°æ®é›†çš„åˆ†ç»„ä¿¡æ¯ï¼Œé™¤éæ˜ç¡®åŠ å…¥åˆ†ç»„å˜é‡æˆ–è®¾å®š `.by_group = TRUE`]]

--

.full-width[.content-box-blue.bold.font120.note[ç¼ºå¤±å€¼æ€»æ˜¯æ’åœ¨æœ€å &lt;sup&gt;.red[*]&lt;/sup&gt; ]]

--
.pull-left[

```r
df &lt;- tibble(x = c(1, 3, 2, NA))
arrange(df, x)
```

```
#&gt; # A tibble: 4 Ã— 1
#&gt;       x
#&gt;   &lt;dbl&gt;
#&gt; 1     1
#&gt; 2     2
#&gt; 3     3
*#&gt; 4    NA
```
]

--
.pull-right[

```r
df &lt;- tibble(x = c(1, 3, 2, NA))
arrange(df, desc(x))
```

```
#&gt; # A tibble: 4 Ã— 1
#&gt;       x
#&gt;   &lt;dbl&gt;
#&gt; 1     3
#&gt; 2     2
#&gt; 3     1
*#&gt; 4    NA
```
]

--

.footnote.red[*ï¼š`base::sort()` å’Œ `base::order()` é€šè¿‡å‚æ•° `na.last` æ¥æ§åˆ¶æŠŠç¼ºå¤±å€¼æ”¾åœ¨å“ªé‡Œæˆ–åˆ é™¤ï¼Œå¹¶é€šè¿‡å‚æ•° `decreasing` æ¥æ§åˆ¶æ’åºæ–¹å‘ã€‚]

---
layout: false
class: inverse, center, middle

# 2. å˜é‡å¤„ç†

.font150[(manipulate variables)]

---
layout: true

### &gt;&gt; å˜é‡é€‰å–ï¼š`select(.data, ...)`

---


```r
select(flights, month, day, dep_time, sched_dep_time, dep_delay)  # æšä¸¾å¼ï¼šå˜é‡åï¼Œæ— éœ€""
```

```
#&gt; # A tibble: 336,776 Ã— 5
#&gt;   month   day dep_time sched_dep_time dep_delay
#&gt;   &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;
#&gt; 1     1     1      517            515         2
#&gt; 2     1     1      533            529         4
#&gt; 3     1     1      542            540         2
#&gt; # â„¹ 336,773 more rows
```

--


```r
select(flights, 2, 3, 4, 5, 6)  # æšä¸¾å¼ï¼šè¡¨ç¤ºå˜é‡ä½ç½®çš„æ•°å­—ï¼Œç»“æœåŒä¸Šï¼Œä½†ä¸æ¨è
```

--

```r
select(flights, month:dep_delay)  # ç”¨ : é€‰æ‹©è¿åœ¨ä¸€èµ·çš„å˜é‡
select(flights, 2:6)
```

--

```r
select(flights, !(month:dep_delay))  # å˜é‡å‰çš„ ! æˆ– - è¡¨ç¤ºå‰”é™¤
```

```
#&gt; # A tibble: 336,776 Ã— 14
#&gt;    year arr_time sched_arr_time arr_delay carrier flight tailnum origin dest  air_time
#&gt;   &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt; &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt;
#&gt; 1  2013      830            819        11 UA        1545 N14228  EWR    IAH        227
#&gt; 2  2013      850            830        20 UA        1714 N24211  LGA    IAH        227
#&gt; 3  2013      923            850        33 AA        1141 N619AA  JFK    MIA        160
#&gt; # â„¹ 336,773 more rows
#&gt; # â„¹ 4 more variables: distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;
```

---

.full-width[.content-box-blue.bold.font110.note[`select()` çš„å¸®åŠ©å‡½æ•°ï¼Œå·²æå‡ºåˆ° `tidyselect` åŒ…ä¸­ï¼Œ`?select_helpers`]]

  1. `starts_with("abc")`ï¼šé€‰å–å˜é‡åä»¥ `abc` å¼€å¤´çš„å˜é‡
  2. `ends_with("xyz")`ï¼šé€‰å–å˜é‡åä»¥ `xyz` ç»“æŸçš„å˜é‡
  3. `contains("ijk")`ï¼šé€‰å–å˜é‡ååŒ…å« `ijk` çš„å˜é‡
  4. `matches("(.)\\1")`ï¼šé€‰å–å˜é‡åä¸­å‡ºç°é‡å¤å­—ç¬¦çš„å˜é‡
  5. `num_range("x", 1:3)`ï¼šé€‰å–å˜é‡ `x1`ã€`x2` å’Œ `x3`
  6. `any_of(x) | all_of(x)`ï¼šé€‰æ‹©æ•´æ•°å‘é‡ `x` æŒ‡å®šä½ç½®æˆ–*å­—ç¬¦å‘é‡* `x` ç›´æ¥æŒ‡å®šçš„å˜é‡
  7. `last_col(offset = 0L)`ï¼šé€‰æ‹©ä»æœ€åç®—èµ·çš„ç¬¬ `offset+1` ä¸ªçš„å˜é‡
  8. `everything()`ï¼šå…¨éƒ¨å˜é‡ï¼Œé€šå¸¸æ”¾åœ¨æœ€å
  9. `where(fn)`ï¼šé€‰æ‹©æ»¡è¶³æ–­è¨€å‡½æ•° `fn` æ¡ä»¶çš„å˜é‡ï¼Œå¦‚ `select(data, where(is.integer))`

--

.full-width[.content-box-blue.bold.font110.note[`select()`ï¼šå¯æ··åˆä½¿ç”¨å„ç§æ–¹æ³•]]


```r
select(flights, year:day, ends_with("_delay") | starts_with("dep_"), tailnum)
```

```
#&gt; # A tibble: 336,776 Ã— 7
#&gt;    year month   day dep_delay arr_delay dep_time tailnum
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;int&gt; &lt;chr&gt;  
#&gt; 1  2013     1     1         2        11      517 N14228 
#&gt; 2  2013     1     1         4        20      533 N24211 
#&gt; 3  2013     1     1         2        33      542 N619AA 
#&gt; # â„¹ 336,773 more rows
```

---
layout: false

### &gt;&gt; å˜é‡é‡å‘½åï¼š`select()`ã€`rename()` å’Œ `rename_with()`


```r
select(flights, nian = year, yue = month, ri = day)  # é€‰å–å˜é‡çš„åŒæ—¶é‡å‘½åå˜é‡
```

```
#&gt; # A tibble: 336,776 Ã— 3
#&gt;    nian   yue    ri
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;
#&gt; 1  2013     1     1
#&gt; 2  2013     1     1
#&gt; 3  2013     1     1
#&gt; # â„¹ 336,773 more rows
```

--


```r
# select() åªä¿ç•™æŒ‡å®šçš„å˜é‡ï¼Œè€Œ rename(.data, ...) åˆ™ä¼šä¿ç•™å…¨éƒ¨å˜é‡
rename(flights, nian = year, yue = month, ri = day) %&gt;% dim()
```

```
#&gt; [1] 336776     19
```

--


```r
# rename_with(.data, .fn, .cols = everything(), ...)
rename_with(flights, toupper, 1:3)
```

```
#&gt; # A tibble: 336,776 Ã— 19
#&gt;    YEAR MONTH   DAY dep_time sched_dep_time dep_delay arr_time sched_arr_time arr_delay
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;
#&gt; 1  2013     1     1      517            515         2      830            819        11
#&gt; 2  2013     1     1      533            529         4      850            830        20
#&gt; 3  2013     1     1      542            540         2      923            850        33
#&gt; # â„¹ 336,773 more rows
#&gt; # â„¹ 10 more variables: carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;,
#&gt; #   dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;,
#&gt; #   time_hour &lt;dttm&gt;
```

---
layout: false

### &gt;&gt; å˜é‡æ¬¡åºè°ƒæ•´ï¼š`select()` å’Œ `relocate()`


```r
select(flights, dest, year:day, ends_with("_delay"), everything())
```

```
#&gt; # A tibble: 336,776 Ã— 19
#&gt;   dest   year month   day dep_delay arr_delay dep_time sched_dep_time arr_time
#&gt;   &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;    &lt;int&gt;
#&gt; 1 IAH    2013     1     1         2        11      517            515      830
#&gt; 2 IAH    2013     1     1         4        20      533            529      850
#&gt; 3 MIA    2013     1     1         2        33      542            540      923
#&gt; # â„¹ 336,773 more rows
#&gt; # â„¹ 10 more variables: sched_arr_time &lt;int&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;,
#&gt; #   origin &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;,
#&gt; #   time_hour &lt;dttm&gt;
```

--


```r
relocate(flights, dest, year:day, ends_with("_delay"))  # ç»“æœåŒä¸Š
```

--


```r
# relocate(.data, ..., .before = NULL, .after = NULL)
relocate(flights, ends_with("_delay"), .after = day)
```

```
#&gt; # A tibble: 336,776 Ã— 19
#&gt;    year month   day dep_delay arr_delay dep_time sched_dep_time arr_time sched_arr_time
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;    &lt;int&gt;          &lt;int&gt;
#&gt; 1  2013     1     1         2        11      517            515      830            819
#&gt; 2  2013     1     1         4        20      533            529      850            830
#&gt; 3  2013     1     1         2        33      542            540      923            850
#&gt; # â„¹ 336,773 more rows
#&gt; # â„¹ 10 more variables: carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;,
#&gt; #   dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;,
#&gt; #   time_hour &lt;dttm&gt;
```

---
layout: true

### &gt;&gt; ç”Ÿæˆæ–°å˜é‡ï¼š`mutate()`

---

.full-width[.content-box-blue.bold.font120[`mutate(.data, ...)`ï¼šç”Ÿæˆæ–°å˜é‡ .red[&lt;sup&gt; *&lt;/sup&gt;]]]
--


```r
flights_sml &lt;- select(flights, year:day, ends_with("_delay"), air_time)
```
--


```r
mutate(flights_sml,
  gain = arr_delay - dep_delay,
  hours = air_time / 60,
  gain_per_hour = gain / hours    # å¯ç›´æ¥å¼•ç”¨æ–°ç”Ÿæˆçš„å˜é‡
)
```

```
#&gt; # A tibble: 336,776 Ã— 9
#&gt;    year month   day dep_delay arr_delay air_time  gain hours gain_per_hour
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;         &lt;dbl&gt;
#&gt; 1  2013     1     1         2        11      227     9  3.78          2.38
#&gt; 2  2013     1     1         4        20      227    16  3.78          4.23
#&gt; 3  2013     1     1         2        33      160    31  2.67         11.6 
#&gt; # â„¹ 336,773 more rows
```

--
.footnote.red[*ï¼šå®Œæ•´å‚æ•°ç‰ˆä¸º `mutate(.data, ..., .by = NULL, .keep = c("all", "used", "unused", "none"), .before = NULL, .after = NULL)`ï¼ˆå…¶ä¸­ï¼š`.keep`ã€`.before`å’Œ`.after`ä¸º dplyr&lt;sup&gt;v1.0.0&lt;/sup&gt; æ–°å¢å‚æ•°ï¼Œdplyr&lt;sup&gt;v1.1.0&lt;/sup&gt; åˆæ–°å¢å®éªŒæ€§å‚æ•° `.by`ï¼‰ï¼›&lt;br&gt;2. å‡å¦‚ä½ åªæƒ³ä¿ç•™æ–°ç”Ÿæˆçš„å˜é‡ï¼Œé‚£å°±~~ä½¿ç”¨ `transmute()` æˆ–~~è®¾å®š `mutate()` å‚æ•° `.keep = "none"`ã€‚]

---

.full-width[.content-box-blue.bold.font120[`mutate()`ï¼šæ”¯æŒå‘é‡åŒ–å‡½æ•° &lt;sup&gt;.red[*]&lt;/sup&gt;]]

.code75[

```r
*MATH
  +, - , *, /, ^, %/%, %%    # arithmetic ops
  log(), log2(), log10()     # logs
  &lt;, &lt;=, &gt;, &gt;=, !=, ==       # logical comparisons
*CUMULATIVE AGGREGATES        # vignette("window-functions")
  dplyr::cumall()|cumany()   # cumulative all() | any()
  cummax()|cummin()          # cumulative max() | min()
  dplyr::cummean()           # cumulative mean()
  cumprod()|cumsum()         # cumulative prod() | sum()
*OFFSETS
  dplyr::lag()|lead()        # offset elements by 1 | -1
*RANKINGS                     # ?ranking
  dplyr::min_rank()          # rank with ties = min
  dplyr::ntile()             # bins into n bins
  dplyr::row_number()        # rank with ties = "first"
*MISC
  pmax()|pmin()              # element-wise max() | min()
  dplyr::recode()            # vectorized switch()
  dplyr::if_else()           # vectorized if() + else()
  dplyr::case_when()         # multi-case if_else()
```
]

.footnote.red[*ï¼šå½“ç„¶ä¹Ÿæ”¯æŒè¿”å›â€œæ ‡é‡â€çš„æ±‡æ€»å‡½æ•°ï¼Œå¦‚ `mean()`ï¼Œä¼šå°†æ ‡é‡ç›´æ¥æ‰©å±•è‡³éœ€è¦çš„é•¿åº¦ã€‚]

---

.full-width[.content-box-blue.bold.font120[å¤šåˆ—æ“ä½œ ğŸ‘‰ .font80[ `vignette("colwise")`]]]

.code90[

```r
# ?scoped
# *_all() ä½œç”¨äºæ¯ä¸ªå˜é‡
# *_at()  ä½œç”¨äºç”¨ vars() å‡½æ•°ã€å­—ç¬¦å‘é‡æˆ–ä½ç½®å‘é‡æŒ‡å®šçš„å˜é‡
# *_if()  ä½œç”¨äº .predicate å‡½æ•°å–å€¼ä¸º TRUE çš„å˜é‡
mutate_all(.tbl, .funs, ...)
mutate_at(.tbl, .vars, .funs, ...)
mutate_if(.tbl, .predicate, .funs, ...)
# summarize()ã€group_by()ã€arrange()ã€filter()ã€rename()ç­‰ä¹Ÿå­˜åœ¨ç±»ä¼¼çš„å˜ä½“å‡½æ•°
```
]

--

.font110.bold.note[dplyr&lt;sup&gt;v1.0.0&lt;/sup&gt; ä½¿ç”¨æ›´å…·ä¼˜åŠ¿çš„ `across(.cols = everything(), .fns = NULL, ..., .names = NULL, .unpack = FALSE)` æ¥æ›¿ä»£ä¸Šè¿°ä¸ºæ•°ä¼—å¤šçš„å˜ä½“å‡½æ•°]


```r
mutate(flights_sml, across(dep_delay:air_time, \(x) x / 60))  # åŒ¿åå‡½æ•°
```

```
#&gt; # A tibble: 336,776 Ã— 6
#&gt;    year month   day dep_delay arr_delay air_time
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
#&gt; 1  2013     1     1    0.0333     0.183     3.78
#&gt; 2  2013     1     1    0.0667     0.333     3.78
#&gt; 3  2013     1     1    0.0333     0.55      2.67
#&gt; # â„¹ 336,773 more rows
```

---
layout: false
class: inverse, center, middle

# 3. æ±‡æ€»

.font150[(summarize / reframe)]

---
layout: true

### &gt;&gt; æ±‡æ€»ï¼š`summarize()`

---

.font120[
- `summarize(.data, ..., .by = NULL, .groups = NULL)` å‡½æ•°ç”Ÿæˆæ–°çš„æ•°æ®æ¡†ï¼Œæ¯ä¸ªæ±‡æ€»å‡½æ•°å ä¸€åˆ—ï¼Œæ¯ä¸ªåˆ†ç»„å ç”¨ä¸€è¡Œï¼›

- å¦‚æœ `.data` æ˜¯[åˆ†ç»„æ•°æ®æ¡† ğŸ‘‡](#56)ï¼Œåˆ™æ¯ä¸ªåˆ†ç»„å˜é‡è¿˜ä¼šå ä¸€åˆ—ï¼›æ­¤æ—¶ï¼Œè¿˜å¯ç”¨ dplyr&lt;sup&gt;v1.0.0&lt;/sup&gt; æ–°å¢çš„å®éªŒæ€§å‚æ•° `.groups = c("drop_last", "drop", "keep", "rowwise")` æ¥æ§åˆ¶æ–°ç”Ÿæˆç»“æœæ•°æ®æ¡†çš„åˆ†ç»„ç»“æ„ï¼›

- å¦‚æœåªæƒ³å¯¹ `.data` è¿›è¡Œä¸€æ¬¡æ€§çš„åˆ†ç»„æ±‡æ€»ï¼ˆä¸ä¿ç•™åˆ†ç»„ç»“æ„ï¼‰ï¼Œåˆ™å¯ä½¿ç”¨ dplyr&lt;sup&gt;v1.1.0&lt;/sup&gt; æ–°å¢çš„å®éªŒæ€§åˆ†ç»„å‚æ•° `.by`ã€‚
]


```r
summarize(
  flights, 
  mean_delay = mean(dep_delay, na.rm = TRUE), 
  sd_delay   = sd(dep_delay, na.rm = TRUE)
)
```

```
#&gt; # A tibble: 1 Ã— 2
#&gt;   mean_delay sd_delay
#&gt;        &lt;dbl&gt;    &lt;dbl&gt;
#&gt; 1       12.6     40.2
```

---

.font120.note[`summarize()` æ”¯æŒè¿”å›â€œæ ‡é‡â€çš„æ±‡æ€»å‡½æ•°&lt;sup&gt;.red[*]&lt;/sup&gt;ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š]


```r
*COUNTS
  dplyr::n()                # number of values/rows
  dplyr::n_distinct()       # number of uniques
  sum(!is.na())             # number of non-NAâ€™s
*LOCATION
  mean() | median()         # mean | median
*POSITION/ORDER
  dplyr::first()            # first value
  dplyr::last()             # last value
  dplyr::nth()              # value in n-th location of vector
*RANK
  quantile()                # nth quantile
  min() | max()             # minimum value | maximum value
*SPREAD
  IQR()                     # Inter-Quartile Range
  mad()                     # median absolute deviation
  sd()                      # standard deviation
  var()                     # variance
```

.footnote.red[*ï¼šdplyr&lt;sup&gt;v1.0.0&lt;/sup&gt; æ‰©å±•äº† `summarize()` çš„çµæ´»æ€§ï¼ˆå…è®¸å…¶è¿”å›åŒ…å«å¤šä¸ªå…ƒç´ çš„å‘é‡ç”šè‡³æ˜¯å¤šè¡Œå¤šåˆ—çš„æ•°æ®æ¡†ï¼‰ï¼Œä½† dplyr&lt;sup&gt;v1.1.0&lt;/sup&gt; åœ¨æ­¤åº”ç”¨æƒ…æ™¯ä¸‹ä¼šæç¤ºæ”¹ç”¨å®éªŒæ€§çš„ `reframe()`ã€‚]

---
layout: true

### &gt;&gt; çµæ´»æ±‡æ€»ï¼š`reframe()`

---

.pull-left[

```r
quantile_df &lt;- function(x, probs) {
  tibble(x = quantile(x, probs, 
                      na.rm = TRUE), 
         probs = probs)
}

flights %&gt;% 
  summarize(
    across(c(dep_delay, arr_delay), 
           ~ quantile_df(
               .x, seq(0, 1, 0.25)
             ),
           .unpack = TRUE
    )
  )
```

```
#&gt; Warning: Returning more (or less) than 1 row per `summarise()` group was deprecated in dplyr
#&gt; 1.1.0.
#&gt; â„¹ Please use `reframe()` instead.
#&gt; â„¹ When switching from `summarise()` to `reframe()`, remember that `reframe()` always
#&gt;   returns an ungrouped data frame and adjust accordingly.
#&gt; Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.
```

```
#&gt; # A tibble: 5 Ã— 4
#&gt;   dep_delay_x dep_delay_probs arr_delay_x arr_delay_probs
#&gt;         &lt;dbl&gt;           &lt;dbl&gt;       &lt;dbl&gt;           &lt;dbl&gt;
#&gt; 1         -43            0            -86            0   
#&gt; 2          -5            0.25         -17            0.25
#&gt; 3          -2            0.5           -5            0.5 
#&gt; 4          11            0.75          14            0.75
#&gt; 5        1301            1           1272            1
```
]

--

.pull-right[

```r
flights %&gt;% 
* reframe(
    across(c(dep_delay, arr_delay), 
           ~ quantile_df(
               .x, seq(0, 1, 0.25)
             ),
           .unpack = TRUE
    )
  )
```

```
#&gt; # A tibble: 5 Ã— 4
#&gt;   dep_delay_x dep_delay_probs arr_delay_x arr_delay_probs
#&gt;         &lt;dbl&gt;           &lt;dbl&gt;       &lt;dbl&gt;           &lt;dbl&gt;
#&gt; 1         -43            0            -86            0   
#&gt; 2          -5            0.25         -17            0.25
#&gt; 3          -2            0.5           -5            0.5 
#&gt; 4          11            0.75          14            0.75
#&gt; 5        1301            1           1272            1
```
]

---
layout: false
class: inverse, center, middle

# 4. åˆ†ç»„å’Œè¡Œå¼å¤„ç†

.font150[(grouping and rowwise)]

---
layout: true

### &gt;&gt; åˆ†ç»„å¤„ç†ï¼š`group_by()` .font80[ğŸ‘‰ `vignette("grouping")`]

---

.font100[
- `group_by(.data, ..., .add = FALSE, .drop = group_by_drop_default(.data))` å°†æ•°æ®æ¡†åŠå…¶æ‰©å±•è½¬å˜ä¸ºåˆ†ç»„æ•°æ®æ¡†ï¼ˆ`grouped_df`ï¼‰
]

--

.pull-left[


```r
by_day &lt;- group_by(flights, 
                   year, month, day)
class(by_day)
```

```
#&gt; [1] "grouped_df" "tbl_df"     "tbl"       
#&gt; [4] "data.frame"
```


```r
by_day
```

```
#&gt; # A tibble: 336,776 Ã— 19
*#&gt; # Groups:   year, month, day [365]
#&gt;    year month   day dep_time sched_dep_time
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;
#&gt; 1  2013     1     1      517            515
#&gt; 2  2013     1     1      533            529
#&gt; 3  2013     1     1      542            540
#&gt; # â„¹ 336,773 more rows
#&gt; # â„¹ 14 more variables: dep_delay &lt;dbl&gt;,
#&gt; #   arr_time &lt;int&gt;, sched_arr_time &lt;int&gt;,
#&gt; #   arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;,
#&gt; #   flight &lt;int&gt;, tailnum &lt;chr&gt;,
#&gt; #   origin &lt;chr&gt;, dest &lt;chr&gt;,
#&gt; #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, â€¦
```

]

--

.pull-right[

.font100.bold.note[è·å–åˆ†ç»„å…ƒæ•°æ®çš„ç›¸å…³å‡½æ•°]


```r
by_day %&gt;% group_vars()
```

```
#&gt; [1] "year"  "month" "day"
```

```r
by_day %&gt;% group_data()
```

```
#&gt; # A tibble: 365 Ã— 4
#&gt;    year month   day       .rows
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;list&lt;int&gt;&gt;
#&gt; 1  2013     1     1       [842]
#&gt; 2  2013     1     2       [943]
#&gt; 3  2013     1     3       [914]
#&gt; # â„¹ 362 more rows
```

```r
# group_keys() / 
# group_rows() / group_indices()
# group_size() / n_groups()
```
]

---

.pull-left.code90[


```r
*# åˆ†ç»„æ±‡æ€»
# è¿”å›ç»“æœé»˜è®¤æƒ…å†µä¸‹ä¼šå»é™¤æœ€ä½ä¸€çº§åˆ†ç»„ï¼Œ
# å¹¶æœ‰ç›¸åº”çš„æç¤ºä¿¡æ¯ï¼Œé™¤éè®¾å®šå‚æ•° 
# .groups = 'keep'
summarize(
  by_day, 
  mean_delay = mean(
    dep_delay, na.rm = TRUE
  )
)
```

```
#&gt; `summarise()` has grouped output by
#&gt; 'year', 'month'. You can override using
#&gt; the `.groups` argument.
```

```
#&gt; # A tibble: 365 Ã— 4
*#&gt; # Groups:   year, month [12]
#&gt;    year month   day mean_delay
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;      &lt;dbl&gt;
#&gt; 1  2013     1     1       11.5
#&gt; 2  2013     1     2       13.9
#&gt; 3  2013     1     3       11.0
#&gt; # â„¹ 362 more rows
```
]

--

.pull-right.code90[


```r
# å‡å¦‚ä½ è§‰å¾— group_by() + summarize()
# ä¸å¤Ÿå¼ºå¤§ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨å®éªŒæ€§çš„ 
# purrr-style å‡½æ•°ï¼Œå¦‚ group_map()/
# *_modify()/*_walk() ç­‰
group_modify(
  by_day,
  ~ broom::tidy( # what's this?!
      lm(arr_delay ~ dep_delay, 
         data=.x)
    )
)
```

```
#&gt; # A tibble: 730 Ã— 8
*#&gt; # Groups:   year, month, day [365]
#&gt;    year month   day term        estimate
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1  2013     1     1 (Intercept)    0.910
#&gt; 2  2013     1     1 dep_delay      1.03 
#&gt; 3  2013     1     2 (Intercept)   -1.32 
#&gt; # â„¹ 727 more rows
#&gt; # â„¹ 3 more variables: std.error &lt;dbl&gt;,
#&gt; #   statistic &lt;dbl&gt;, p.value &lt;dbl&gt;
```
]


---
layout: true

### &gt;&gt; åˆ†ç»„å¤„ç†ï¼š`.by / by` å‚æ•° .font80[ğŸ‘‰ `?dplyr_by`]

---

.font120[
- `group_by()` å¯¹æ•°æ®æ¡†çš„åˆ†ç»„è®¾å®šä¼šå½±å“åç»­ dplyr åŒ…å‡½æ•°çš„å¤„ç†æ–¹å¼ä¸ç»“æœï¼Œç‰¹åˆ«æ˜¯ `summarize()`ã€`reframe()`ã€`mutate()`ã€`filter()`ã€`slice*()`ç­‰ï¼›å¦‚æœä½ ä¸éœ€è¦åŸºäºåˆ†ç»„è¿›è¡Œåç»­æ“ä½œï¼Œéœ€å…ˆç”¨ `ungroup(x, ...)` å‡½æ•°æ¥å–æ¶ˆå¯¹æ•°æ®é›† `x`ï¼ˆåŸºäºæŒ‡å®šå˜é‡ `...`ï¼‰çš„åˆ†ç»„è®¾å®š
]

--

.font120.bold[
- dplyr&lt;sup&gt;v1.1.0&lt;/sup&gt; æ–°å¢äº†å®éªŒæ€§åˆ†ç»„å‚æ•° `.by / by`ï¼Œåªå¯¹ `.data` è¿›è¡Œä¸€æ¬¡æ€§çš„ä¸´æ—¶åˆ†ç»„ï¼ˆä¸”ä¸ä¿ç•™åˆ†ç»„ç»“æ„ï¼‰
]

--

.pull-left.code90[

```r
summarize(
* group_by(flights,
*          year, month, day),
  mean_delay = mean(
    dep_delay, na.rm = TRUE
  )
)
```

```
#&gt; # A tibble: 365 Ã— 4
#&gt; # Groups:   year, month [12]
#&gt;    year month   day mean_delay
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;      &lt;dbl&gt;
#&gt; 1  2013     1     1       11.5
#&gt; 2  2013     1     2       13.9
#&gt; 3  2013     1     3       11.0
#&gt; # â„¹ 362 more rows
```
]

.pull-right.code90[


```r
summarize(
  flights, 
  mean_delay = mean(
    dep_delay, na.rm = TRUE
  ),
* .by = c(year, month, day)
)
```

```
#&gt; # A tibble: 365 Ã— 4
#&gt;    year month   day mean_delay
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;      &lt;dbl&gt;
#&gt; 1  2013     1     1       11.5
#&gt; 2  2013     1     2       13.9
#&gt; 3  2013     1     3       11.0
#&gt; # â„¹ 362 more rows
```
]

---------------------|------------------------------------
Grouping only affects a single verb	| Grouping is persistent across multiple verbs
Selects variables with tidy-select  |	Computes expressions with data-masking
Summaries use existing order of group keys | Summaries sort group keys in ascending order

  + To prevent surprising results, you can't use `.by` on an existing grouped data frame.

- &lt;https://github.com/tidyverse/dplyr/releases/tag/v1.1.0&gt;
  + The most useful reason to do this is because `.by` only affects a single operation. In the example above, an ungrouped data frame went into the `summarize()` call, so an ungrouped data frame will come out; with `.by`, you never need to remember to `ungroup()` afterwards and you never need to use the `.groups` argument.
  + Additionally, using `summarize()` with `.by` will never sort the results by the group key, unlike with `group_by()`. Instead, the results are returned using the existing ordering of the groups from the original data. We feel this is more predictable, better maintains any ordering you might have already applied with a previous call to `arrange()`, and provides a way to maintain the current ordering without having to resort to factors.
  + This feature was inspired by `data.table`, where the equivalent syntax looks like: `starwars[, .(mean_height = mean(height)), by = .(species, homeworld)]`
  + `with_groups()` is superseded in favor of `.by` (#6582).


---
layout: true

### &gt;&gt; è¡Œå¼å¤„ç†ï¼š`rowwise()`

---

.font110[

- `rowwise(data, ...)` å…è®¸ä½ å¯¹æ•°æ®æ¡†çš„æ¯ä¸€è¡Œè¿›è¡Œè¿ç®—ï¼Œå½“ä¸å­˜åœ¨ç›¸åº”çš„å‘é‡åŒ–å‡½æ•°æ—¶ï¼Œè¿›è¡Œé€è¡Œå¼è¿ç®—å¯ä»¥è®©ä½ é¿å…ç¼–å†™æ˜¾æ€§å¾ªç¯çš„ä»£ç 
- å’Œ `group_by()` ç±»ä¼¼ï¼Œ`rowwise()` å¹¶ä¸æ›´æ”¹æ•°æ®æ¡†çš„ç»“æ„ï¼Œè€Œæ˜¯è®©åç»­çš„ dplyr å‡½æ•°æ“ä½œæŒ‰é€è¡Œå¼è¿›è¡Œ
- `rowwise()` è¿”å›çš„æ˜¯ä¸€ç§ç‰¹æ®Šçš„è¡Œåˆ†ç»„æ•°æ®æ¡†ï¼ˆ`rowwise_df`ï¼Œæ¯è¡Œä¸€ç»„ï¼‰ï¼Œç»å¤§å¤šæ•°çš„ dplyr å‡½æ•°ä¼šä¿ç•™æ•°æ®æ¡†çš„è¡Œåˆ†ç»„ä¿¡æ¯ï¼ˆè¿”å› `grouped_df` çš„ `summarize()` å‡½æ•°æ˜¯ä¸ªä¾‹å¤–ï¼‰ï¼›ä½ å¯ä»¥é€šè¿‡ `ungroup()` æˆ– `as_tibble()` å‡½æ•°æ¥å–æ¶ˆè¡Œåˆ†ç»„ï¼Œæˆ–é€šè¿‡ `group_by()` å‡½æ•°è½¬å˜ä¸º `grouped_df`

]

--

.pull-left[


```r
flights_rw &lt;- rowwise(flights_sml)
class(flights_rw)
```

```
#&gt; [1] "rowwise_df" "tbl_df"     "tbl"       
#&gt; [4] "data.frame"
```


```r
flights_rw
```

```
#&gt; # A tibble: 336,776 Ã— 6
*#&gt; # Rowwise: 
#&gt;    year month   day dep_delay arr_delay air_time
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
#&gt; 1  2013     1     1         2        11      227
#&gt; 2  2013     1     1         4        20      227
#&gt; 3  2013     1     1         2        33      160
#&gt; # â„¹ 336,773 more rows
```
]

--

.pull-right[

```r
# long time to run
mutate(
  flights_rw, 
  max_delay = 
*   max(c_across(ends_with("_delay")))
)
```

```
#&gt; # A tibble: 336,776 Ã— 7
*#&gt; # Rowwise: 
#&gt;    year month   day dep_delay arr_delay
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;     &lt;dbl&gt;
#&gt; 1  2013     1     1         2        11
#&gt; 2  2013     1     1         4        20
#&gt; 3  2013     1     1         2        33
#&gt; # â„¹ 336,773 more rows
#&gt; # â„¹ 2 more variables: air_time &lt;dbl&gt;,
#&gt; #   max_delay &lt;dbl&gt;
```

]

---

.full-width[.content-box-blue.bold.font120[ä¸€ä¸ªç¨å¾®å¤æ‚ï¼ˆä½†æ€è·¯ç±»ä¼¼çš„ï¼‰ä¾‹å­]]

.pull-left[


```r
nest_flights &lt;- nest_by(
  flights_sml, year, month, day)
nest_flights
```

```
#&gt; # A tibble: 365 Ã— 4
*#&gt; # Rowwise:  year, month, day
#&gt;    year month   day               data
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;list&lt;tibble[,3]&gt;&gt;
#&gt; 1  2013     1     1          [842 Ã— 3]
#&gt; 2  2013     1     2          [943 Ã— 3]
#&gt; 3  2013     1     3          [914 Ã— 3]
#&gt; 4  2013     1     4          [915 Ã— 3]
#&gt; 5  2013     1     5          [720 Ã— 3]
#&gt; # â„¹ 360 more rows
```

]

--

.pull-right[


```r
*mutate(
  nest_flights, 
  mean_delay = mean(
    data$dep_delay, na.rm = TRUE
  ),
  .keep = "none"
)
```

```
#&gt; # A tibble: 365 Ã— 4
*#&gt; # Rowwise:  year, month, day
#&gt;    year month   day mean_delay
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;      &lt;dbl&gt;
#&gt; 1  2013     1     1      11.5 
#&gt; 2  2013     1     2      13.9 
#&gt; 3  2013     1     3      11.0 
#&gt; 4  2013     1     4       8.95
#&gt; 5  2013     1     5       5.73
#&gt; # â„¹ 360 more rows
```

]

--

.font100[ğŸ‘‰ `vignette("rowwise")`]

---
layout: false
class: inverse, center, middle
background-image: url(imgs/logo-magrittr.png), url(imgs/bg.png)
background-size: 10%, 100%
background-position: 15% 40%, 0% 100%

# 5. ç”¨ `%&gt;%` è¿æ¥å¤šä¸ªæ“ä½œ

.font150[(chaining multiple operations with the pipe `%&gt;%`)]

---
layout: true

### &gt;&gt; ç®¡é“è¿ç®—ç¬¦ï¼š`%&gt;%`

---
.full-width[.content-box-blue.bold.font120[ä¸ç”¨&amp;nbsp;`%&gt;%`&amp;nbsp;çš„ä»£ç ]]

.pull-left[

```r
by_dest &lt;- group_by(flights, dest)

delay &lt;- summarize(
  by_dest,
  count = n(),
  dist = mean(distance, na.rm = TRUE),
  delay = mean(arr_delay, na.rm = TRUE)
)

delay &lt;- filter(delay, 
                count &gt; 20, 
                dest != "HNL")

ggplot(delay, 
       aes(x = dist, y = delay)) +
  geom_point(aes(size = count), 
             alpha = 1/3) +
  geom_smooth(se = FALSE)
```
]

&lt;br&gt;&lt;br&gt;

.pull-right[

&lt;img src="L04_Transformation_files/figure-html/unnamed-chunk-57-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]

---
.full-width[.content-box-blue.bold.font120[ä½¿ç”¨&amp;nbsp;`%&gt;%`&amp;nbsp;çš„ä»£ç ï¼ˆ&amp;nbsp;`%&gt;%`&amp;nbsp;æ¥è‡ª&amp;nbsp;`magrittr`&amp;nbsp;åŒ…ï¼Œå¿«æ·é”®ä¸º&amp;nbsp;`Ctrl+Shift+M`&amp;nbsp;ï¼‰]]

.pull-left[

```r
# ç”¨ %&gt;% æ”¹å†™å‰ä¸€é¡µçš„ä»£ç 
flights %&gt;% 
  group_by(dest) %&gt;% 
  summarize(
    count = n(),
    dist = mean(distance, na.rm = TRUE),
    delay = mean(arr_delay, na.rm = TRUE)
  ) %&gt;% 
  filter(count &gt; 20, dest != "HNL") %&gt;% 
  ggplot(aes(x = dist, y = delay)) +
    geom_point(aes(size = count), 
               alpha = 1/3) +
    geom_smooth(se = FALSE)
```
]

--

.pull-right.font110[

* è®©å‡½æ•°å…¼å®¹ç®¡é“æ“ä½œç¬¦æœ‰åŠ©äºå®ç° `tidyverse` çš„[{{æ ¸å¿ƒåŸåˆ™}}](https://design.tidyverse.org/unifying.html)

* ä½¿ç”¨ `%&gt;%` ç¼–å†™çš„ä»£ç å…³æ³¨åŠ¨è¯ï¼ˆå¦‚æ•°æ®å˜æ¢æ“ä½œï¼‰è€Œéåè¯ï¼ˆæ“ä½œå¯¹è±¡ï¼‰ï¼Œè¿™ä½¿å¾—ä»£ç æ›´å®¹æ˜“å†™ï¼Œæ›´å®¹æ˜“è¯»ï¼Œä¹Ÿæ›´å®¹æ˜“ä¿®æ”¹

* `dplyr` åŒ…çš„å‡½æ•°å…·å¤‡è¿™æ ·çš„ç‰¹æ€§ï¼š`f(.data01, ...)  -&gt; .data02`ï¼Œâ€œæ•°æ®è¿›ï¼Œæ•°æ®å‡ºâ€ï¼Œæ›´é€‚ç”¨äºç®¡é“æ“ä½œ

* `dplyr` åŒ…ä¼šåœ¨åå°è‡ªåŠ¨å°† `x %&gt;% f(y)` è½¬å˜ä¸º `f(x, y)`ï¼Œå°† `x %&gt;% f(y, .)` è½¬å˜ä¸º `f(y, x)`ï¼Œå°† `x %&gt;% f(y, z = .)`  è½¬å˜ä¸º `f(y, z = x)` â€¦â€¦

]

---
.full-width[.content-box-blue.bold.font120[ä½¿ç”¨&amp;nbsp;`%&gt;%`&amp;nbsp;çš„ä¾‹å­ï¼Œonce moreï¼Œâœˆï¸]]


```r
flights %&gt;% 
  group_by(year, month, day) %&gt;% 
  summarize(mean_delay = mean(dep_delay, na.rm = TRUE)) %&gt;% 
  mutate(date = lubridate::make_date(year, month, day)) %&gt;% 
  ggplot() + geom_line(aes(x = date, y = mean_delay))
```

&lt;img src="L04_Transformation_files/figure-html/unnamed-chunk-59-1.png" width="50%" style="display: block; margin: auto;" /&gt;

---
.full-width[.content-box-blue.bold.font120[yet again .red[but with R's native forward pipe operator `|&gt;`]]]


```r
not_cancelled &lt;- flights |&gt;  
  filter(!is.na(dep_delay), !is.na(arr_delay))

not_cancelled |&gt; 
  group_by(year, month, day) |&gt; 
  summarize(
*   first = dep_time |&gt; min(),
*   last  = dep_time %&gt;% max,
    avg_delay1 = mean(arr_delay),
    avg_delay2 = mean(arr_delay[arr_delay &gt; 0]) # average pos delay
  )
```

```
#&gt; # A tibble: 365 Ã— 7
#&gt; # Groups:   year, month [12]
#&gt;    year month   day first  last avg_delay1 avg_delay2
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;      &lt;dbl&gt;      &lt;dbl&gt;
#&gt; 1  2013     1     1   517  2356      12.7        32.5
#&gt; 2  2013     1     2    42  2354      12.7        32.0
#&gt; 3  2013     1     3    32  2349       5.73       27.7
#&gt; # â„¹ 362 more rows
```

---
layout: false
class: hide_logo

## ğŸ™‹â€â™‚ï¸ Your Turn! 

<div class="countdown" id="special_timer" data-warn-when="10" data-update-every="1" tabindex="0" style="top:0;right:0;font-size:3em;">
<div class="countdown-controls"><button class="countdown-bump-down">&minus;</button><button class="countdown-bump-up">&plus;</button></div>
<code class="countdown-time"><span class="countdown-digits minutes">05</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

.panelset.font120[

.panel[.panel-name[Nested?]
åˆ©ç”¨ç®¡é“æ“ä½œç¬¦ `%&gt;%` æ”¹å†™ä»¥ä¸‹ \# é‡åµŒå¥—çš„ä»£ç ï¼š
.code90[

```r
summarize(
  select(
    group_by(starwars, species, sex),
    height, mass
  ),
  height = mean(height, na.rm = TRUE),
  mass = mean(mass, na.rm = TRUE)
)
```

```
#&gt; # A tibble: 41 Ã— 4
#&gt; # Groups:   species [38]
#&gt;   species  sex   height  mass
#&gt;   &lt;chr&gt;    &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;
#&gt; 1 Aleena   male      79    15
#&gt; 2 Besalisk male     198   102
#&gt; 3 Cerean   male     198    82
#&gt; # â„¹ 38 more rows
```
]
]

.panel[.panel-name[Piped!]
.code90[

```r
starwars %&gt;% 
  group_by(species, sex) %&gt;% 
  select(height, mass) %&gt;% 
  summarize(
    height = mean(height, na.rm = TRUE),
    mass   = mean(mass, na.rm = TRUE)
  )
```

```
#&gt; # A tibble: 41 Ã— 4
#&gt; # Groups:   species [38]
#&gt;   species  sex   height  mass
#&gt;   &lt;chr&gt;    &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;
#&gt; 1 Aleena   male      79    15
#&gt; 2 Besalisk male     198   102
#&gt; 3 Cerean   male     198    82
#&gt; # â„¹ 38 more rows
```
]
]

]

---
layout: false
class: inverse, center, middle

# è¯¾åå¤ä¹ 

---
class: middle

.font130[

ğŸ• å¤ä¹  ğŸ“– [**{{_R for Data Science, 2e_}}**](https://r4ds.had.nz/) ä¸€ä¹¦ç¬¬ä¸€éƒ¨åˆ† _Whole game_ ä¸­å…³äºæ•°æ®å¤„ç†çš„ç« èŠ‚ï¼Œå³ [**4 Data transformation**](https://r4ds.hadley.nz/data-transform) å¹¶**ï¼ˆç»“é˜Ÿï¼‰å®Œæˆè¯¾åç»ƒä¹ **
  &gt; ğŸ‘‰ è¯¾åä¹ é¢˜å‚è€ƒç­”æ¡ˆé“¾æ¥&lt;br&gt;
  &gt; &amp;emsp; [{{R for Data Science (2e): Solutions to Exercises}}](https://mine-cetinkaya-rundel.github.io/r4ds-solutions/data-transform.html)

ğŸ•‘ ä¸‹è½½ï¼ˆæ‰“å°ï¼‰ ğŸ“° [**{{dplyrçš„cheatsheet}}**](docs/dplyr-cheatsheet.pdf) å¹¶é˜…è¯»ä¹‹

ğŸ•’ `browseVignettes(package = "dplyr")` ğŸ“ï¼Œé˜…è¯»ï¼š

&gt; .code80[

```
Introduction to dplyr
Column-wise operations
Grouped data
Row-wise operations
Window functions
```
]

]

---
layout: false
class: inverse, center, middle

# 6. åˆå¹¶æ•°æ®é›†

.font150[(combine tables)]

---

&lt;br&gt;

.pull-left[


```r
airlines
```

```
#&gt; # A tibble: 16 Ã— 2
#&gt;   carrier name                  
#&gt;   &lt;chr&gt;   &lt;chr&gt;                 
#&gt; 1 9E      Endeavor Air Inc.     
#&gt; 2 AA      American Airlines Inc.
#&gt; 3 AS      Alaska Airlines Inc.  
#&gt; # â„¹ 13 more rows
```

```r
planes
```

```
#&gt; # A tibble: 3,322 Ã— 9
#&gt;   tailnum  year type       manufacturer model
#&gt;   &lt;chr&gt;   &lt;int&gt; &lt;chr&gt;      &lt;chr&gt;        &lt;chr&gt;
#&gt; 1 N10156   2004 Fixed winâ€¦ EMBRAER      EMB-â€¦
#&gt; 2 N102UW   1998 Fixed winâ€¦ AIRBUS INDUâ€¦ A320â€¦
#&gt; 3 N103US   1999 Fixed winâ€¦ AIRBUS INDUâ€¦ A320â€¦
#&gt; # â„¹ 3,319 more rows
#&gt; # â„¹ 4 more variables: engines &lt;int&gt;,
#&gt; #   seats &lt;int&gt;, speed &lt;int&gt;, engine &lt;chr&gt;
```

]

--

.pull-right[


```r
airports
```

```
#&gt; # A tibble: 1,458 Ã— 8
#&gt;   faa   name      lat   lon   alt    tz dst  
#&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;
#&gt; 1 04G   Lansdoâ€¦  41.1 -80.6  1044    -5 A    
#&gt; 2 06A   Moton â€¦  32.5 -85.7   264    -6 A    
#&gt; 3 06C   Schaumâ€¦  42.0 -88.1   801    -6 A    
#&gt; # â„¹ 1,455 more rows
#&gt; # â„¹ 1 more variable: tzone &lt;chr&gt;
```

```r
weather
```

```
#&gt; # A tibble: 26,115 Ã— 15
#&gt;   origin  year month   day  hour  temp  dewp
#&gt;   &lt;chr&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;
#&gt; 1 EWR     2013     1     1     1  39.0  26.1
#&gt; 2 EWR     2013     1     1     2  39.0  27.0
#&gt; 3 EWR     2013     1     1     3  39.0  28.0
#&gt; # â„¹ 26,112 more rows
#&gt; # â„¹ 8 more variables: humid &lt;dbl&gt;,
#&gt; #   wind_dir &lt;dbl&gt;, wind_speed &lt;dbl&gt;,
#&gt; #   wind_gust &lt;dbl&gt;, precip &lt;dbl&gt;,
#&gt; #   pressure &lt;dbl&gt;, visib &lt;dbl&gt;,
#&gt; #   time_hour &lt;dttm&gt;
```

]

---
layout: true

### &gt;&gt; é”®ï¼ˆkeysï¼‰

---

.full-width[.content-box-blue.bold.font100[ä¸»é”®ï¼ˆprimary keyï¼‰ï¼šæŒ‡çš„æ˜¯æ•°æ®è¡¨ä¸­ä¸€ä¸ªå˜é‡ï¼ˆåˆ—ï¼‰æˆ–å¤šä¸ªå˜é‡çš„ç»„åˆï¼Œå…¶å€¼èƒ½å”¯ä¸€åœ°æ ‡è¯†è¡¨ä¸­çš„æ¯ä¸€è¡Œã€‚ä¸»é”®ä¸»è¦ç”¨æ¥ä¸å…¶ä»–è¡¨çš„å¤–é”®å…³è”ï¼Œä»¥åŠæœ¬è¡¨çš„ä¿®æ”¹ä¸åˆ é™¤ã€‚]]
--


```r
planes %&gt;% count(tailnum) %&gt;%  filter(n &gt; 1)
```

```
#&gt; # A tibble: 0 Ã— 2
#&gt; # â„¹ 2 variables: tailnum &lt;chr&gt;, n &lt;int&gt;
```

--


```r
weather %&gt;% 
  count(year, month, day, hour, origin) %&gt;% filter(n &gt; 1)
```

```
#&gt; # A tibble: 3 Ã— 6
#&gt;    year month   day  hour origin     n
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;  &lt;int&gt;
#&gt; 1  2013    11     3     1 EWR        2
#&gt; 2  2013    11     3     1 JFK        2
#&gt; 3  2013    11     3     1 LGA        2
```

```r
weather &lt;- weather %&gt;% distinct(year, month, day, hour, origin, .keep_all = TRUE) # ä¿®æ­£ä¹‹
```

--

.full-width[.content-box-blue.bold.font100[å¤–é”®ï¼ˆforeign keyï¼‰ï¼šå¯¹åº”äºå¦ä¸€æ•°æ®è¡¨ä¸»é”®çš„ä¸€ä¸ªæˆ–å¤šä¸ªå˜é‡ã€‚]]

---

&lt;img src="imgs/relational-nycflights.png" width="80%" style="display: block; margin: auto;" /&gt;

---
layout: true

### &gt;&gt; åˆå¹¶å¼è¿æ¥ï¼ˆmutating joinsï¼‰

---

.full-width[.content-box-blue.bold.font110[`*_join(x, y, by = NULL, copy = FALSE, suffix = c(".x", ".y"), ...)`]]

--


```r
flights %&gt;% 
  select(year:day, hour, tailnum, carrier) %&gt;% 
  left_join(airlines)  # ä»¥åŒåå˜é‡ä¸ºåˆå¹¶é”®ï¼Œå¢åŠ å˜é‡ nameï¼ˆèˆªç©ºå…¬å¸å…¨åï¼‰
```

```
#&gt; Joining with `by = join_by(carrier)`
```

```
#&gt; # A tibble: 336,776 Ã— 7
#&gt;    year month   day  hour tailnum carrier name                  
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;                 
#&gt; 1  2013     1     1     5 N14228  UA      United Air Lines Inc. 
#&gt; 2  2013     1     1     5 N24211  UA      United Air Lines Inc. 
#&gt; 3  2013     1     1     5 N619AA  AA      American Airlines Inc.
#&gt; # â„¹ 336,773 more rows
```

--


```r
flights %&gt;% 
  select(year:day, hour, tailnum, carrier) %&gt;% 
* mutate(name = airlines$name[match(carrier, airlines$carrier)]) # æ®Šé€”åŒå½’ï¼Œä½†å®¹æ˜“ç†è§£å—ï¼Ÿ
```

```
#&gt; # A tibble: 336,776 Ã— 7
#&gt;    year month   day  hour tailnum carrier name                  
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;                 
#&gt; 1  2013     1     1     5 N14228  UA      United Air Lines Inc. 
#&gt; 2  2013     1     1     5 N24211  UA      United Air Lines Inc. 
#&gt; 3  2013     1     1     5 N619AA  AA      American Airlines Inc.
#&gt; # â„¹ 336,773 more rows
```

---

.pull-left[

.full-width.content-box-blue.bold.font120[Inner joins]

&lt;img src="imgs/join-inner.png" width="100%" style="display: block; margin: auto;" /&gt;

]
--

.pull-right[

.full-width.content-box-blue.bold.font120[Outer joins]

&lt;img src="imgs/join-outer.png" width="65%" style="display: block; margin: auto;" /&gt;

]

---

.full-width[.content-box-blue.bold.font120.note[ç”¨ `by` å‚æ•°è®¾å®šè¿æ¥æ‰€ç”¨çš„é”®å˜é‡]]

.code95[


```r
# é»˜è®¤æ—¶ï¼ˆå³`by = NULL`ï¼‰ä½¿ç”¨ä¸¤ä¸ªæ•°æ®é›†ä¸­åŒåçš„å…¨éƒ¨å˜é‡ï¼Œå³natural join
# æ­¤æ—¶ä¼šæ˜¾ç¤ºæç¤ºä¿¡æ¯â€œJoining, by = join_by(ä»¥,åˆ†éš”çš„å…¨éƒ¨åŒåå˜é‡)â€
flights %&gt;%
  left_join(weather)

# æ˜¾æ€§è®¾å®š`by = join_by(ä»¥,åˆ†éš”çš„é”®å˜é‡)` æˆ–è€… `by = é”®å˜é‡å­—ç¬¦å‘é‡`
flights %&gt;%
    left_join(weather, 
              by = join_by(year, month, day, origin, hour))

# ä¸¤ä¸ªæ•°æ®é›†çš„å˜é‡ä¸åŒåæ—¶ï¼Œåˆ™æ˜¾æ€§è®¾å®šå¦‚
# `by = join_by(xv1 == yv1, xv2 == yv2)` æˆ–è€… `by = å‘½åå­—ç¬¦å˜é‡å‘é‡`
flights %&gt;% 
  left_join(airports, by = join_by(dest == faa)) # by = c("dest" = "faa")

# dplyr v1.1.0 `by` å‚æ•°è®¾å®šçš„æ–°è¯­æ³• `by = join_by(...)` æ›´åŠ çµæ´»ï¼Œæ”¯æŒéç­‰å€¼
# è¿æ¥ï¼ˆnon-equi joinsï¼‰ï¼ˆå…·ä½“è§åï¼‰
```

]

---

.full-width[.content-box-blue.bold.font120.note[åˆå¹¶å¼è¿æ¥å‡½æ•°`*_join()`çš„å‚æ•° `relationship` .red.font80[&lt;sup&gt;1,3&lt;/sup&gt;]]]

.pull-left.font110[

- .code110.bold[`"one-to-one"`]  
  [[è§å‰]](#92)

- .code110[`"one-to-many"` / `"many-to-one"`]

&lt;img src="imgs/join-one-to-many.png" width="100%" /&gt;

]

.pull-right.font110[

- .code110.bold[`"many-to-many"`]&lt;sup&gt;.red[2]&lt;/sup&gt;

&lt;img src="imgs/join-many-to-many.png" width="100%" /&gt;

]

&lt;br&gt;
.footnote.red[
1. ä¸º dplyr&lt;sup&gt;v1.1.1&lt;/sup&gt; çš„æ–°å¢å‚æ•°ã€‚  
2. é€šå¸¸æ¥è¯´ï¼Œå¯¹ä¸¤ä¸ªæ•°æ®é›†è¿›è¡Œ `many-to-many` çš„ç­‰å€¼åˆå¹¶ï¼ˆ_equi join_ï¼‰å¹¶ä¸åˆç†ï¼Œ`*_join()` å‡½æ•°åœ¨ `relationship` å‚æ•°å–é»˜è®¤å€¼ `NULL` æ—¶ä¼šç»™å‡ºç›¸åº”çš„è­¦å‘Šä¿¡æ¯ã€‚
3. `*_join()` å‡½æ•°çš„å…¶ä»–å‚æ•°ï¼š`keep`ã€`na_matches`ã€`multiple` å’Œ `unmatched`ã€‚
]

---
layout: true

### &gt;&gt; ç­›é€‰å¼è¿æ¥ï¼ˆfiltering joinsï¼‰

---

.full-width[.content-box-blue.bold.font110[`semi_join(x, y, by = NULL, copy = FALSE, ...) | anti_join()` &lt;br&gt;ä¿ç•™ | ä¸¢å¼ƒ `x` æ•°æ®é›†ä¸­åœ¨ `y` æ•°æ®é›†ä¸­æ‰¾å¾—åˆ°åŒ¹é…çš„æ ·æœ¬]]

--


```r
top_dest &lt;- flights %&gt;%
  count(dest, sort = TRUE) %&gt;%
  head(10)
flights %&gt;% 
  filter(dest %in% top_dest$dest)
```

```
#&gt; # A tibble: 141,145 Ã— 19
#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time arr_delay
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;
#&gt; 1  2013     1     1      542            540         2      923            850        33
#&gt; 2  2013     1     1      554            600        -6      812            837       -25
#&gt; 3  2013     1     1      554            558        -4      740            728        12
#&gt; # â„¹ 141,142 more rows
#&gt; # â„¹ 10 more variables: carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;,
#&gt; #   dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;,
#&gt; #   time_hour &lt;dttm&gt;
```
--


```r
flights %&gt;% semi_join(top_dest)
# ç›¸åŒçš„ç»“æœï¼Œä½†æ›´å®¹æ˜“å¤„ç† filter() + %in% æ‰€éš¾ä»¥å¤„ç†çš„å­˜åœ¨å¤šä¸ª key å˜é‡çš„æƒ…å†µ
```

---
layout: true

### &gt;&gt; éç­‰å€¼è¿æ¥ï¼ˆnon-equi joinsï¼‰

---

.pull-left[




```r
# # input data by hand
# transactions &lt;- tibble(
#   company = c("A", "A", "B", "B"),
#   year = c(2019, 2020, 2021, 2023),
#   revenue = c(50, 4, 10, 12)
# )
transactions
```

```
#&gt; # A tibble: 4 Ã— 3
#&gt;   company  year revenue
#&gt;   &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt;
#&gt; 1 A        2019      50
#&gt; 2 A        2020       4
#&gt; 3 B        2021      10
#&gt; 4 B        2023      12
```

```r
companies
```

```
#&gt; # A tibble: 3 Ã— 3
#&gt;   id    since name     
#&gt;   &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;    
#&gt; 1 A      1973 Patagonia
#&gt; 2 B      2009 RStudio  
#&gt; 3 B      2022 Posit
```

]

--

.pull-right[


```r
# 1. Equality Joins:
transactions |&gt; 
  left_join(companies, 
*           by = join_by(company == id))
```

```
#&gt; Warning in left_join(transactions, companies, by = join_by(company == id)): Detected an unexpected many-to-many
#&gt; relationship between `x` and `y`.
#&gt; â„¹ Row 3 of `x` matches multiple rows in `y`.
#&gt; â„¹ Row 1 of `y` matches multiple rows in `x`.
#&gt; â„¹ If a many-to-many relationship is
#&gt;   expected, set `relationship =
#&gt;   "many-to-many"` to silence this warning.
```

```
#&gt; # A tibble: 6 Ã— 5
#&gt;   company  year revenue since name     
#&gt;   &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;    
#&gt; 1 A        2019      50  1973 Patagonia
#&gt; 2 A        2020       4  1973 Patagonia
*#&gt; 3 B        2021      10  2009 RStudio  
*#&gt; 4 B        2021      10  2022 Posit    
*#&gt; 5 B        2023      12  2009 RStudio  
*#&gt; 6 B        2023      12  2022 Posit
```

.font120[ğŸ¤” å¦‚ä½•è§£å†³ï¼Ÿ]

]

---

.pull-left[


```r
# 2. Inequality Joins: 

# involves at least one join expression
# containing one of inequality 
# conditions: &gt;=, &gt;, &lt;=, or &lt;.

transactions |&gt;
  left_join(companies, 
    join_by(company == id, 
*           year &gt;= since))
```

```
#&gt; # A tibble: 5 Ã— 5
#&gt;   company  year revenue since name     
#&gt;   &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;    
#&gt; 1 A        2019      50  1973 Patagonia
#&gt; 2 A        2020       4  1973 Patagonia
*#&gt; 3 B        2021      10  2009 RStudio  
*#&gt; 4 B        2023      12  2009 RStudio  
#&gt; 5 B        2023      12  2022 Posit
```

]

--

.pull-right[


```r
# 3. Rolling Joins: 
transactions |&gt;
  left_join(companies, 
    join_by(company == id, 
*           closest(year &gt;= since)))
```

```
#&gt; # A tibble: 4 Ã— 5
#&gt;   company  year revenue since name     
#&gt;   &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;    
#&gt; 1 A        2019      50  1973 Patagonia
#&gt; 2 A        2020       4  1973 Patagonia
*#&gt; 3 B        2021      10  2009 RStudio  
*#&gt; 4 B        2023      12  2022 Posit
*```

```r
# 4. Overlap Joins:

# three helpers for overlap joins: 
# between(), overlaps(), and within()
```

]

--

&lt;br&gt;
.font120[ğŸ‘‰ `?join_by`]

---
layout: true

### &gt;&gt; å…¶å®ƒç±»å‹çš„åˆå¹¶

---
.pull-left[

.full-width.content-box-blue.bold.font120[`cross_join()`&amp;ensp;/&amp;ensp;`nest_join()`]

.font100[
+ `cross_join(x, y, ...)` å°†æ•°æ®é›†`x`ä¸­çš„æ¯ä¸€è¡Œä¸æ•°æ®é›†`y`ä¸­çš„æ¯ä¸€è¡Œè¿›è¡ŒåŒ¹é…ï¼Œç»“æœä¸º`nrow(x) * nrow(y)`è¡Œ

+ `nest_join(x, y, by = NULL, ...)` ä¿ç•™æ•°æ®é›†`x`ï¼Œå¹¶å°†åŒ¹é…çš„æ•°æ®é›†`y`çš„æ•°æ®ä½œä¸ºæ–°å¢çš„åˆ—è¡¨åˆ—ï¼Œå…ƒç´ ä¸º `tibble`ï¼ˆå½“åœ¨æ•°æ®é›†`y`ä¸­æ‰¾ä¸åˆ°åŒ¹é…æ•°æ®æ—¶ï¼Œåˆ—è¡¨åˆ—ç›¸åº”ä½ç½®å¡«å……ä¸€ä¸ª0è¡Œçš„`tibble`ï¼‰

+ ä»æŸç§æ„ä¹‰ä¸Šè¯´ï¼Œ`cross_join()` å’Œ `nest_join()` æ˜¯æœ€åŸºç¡€çš„æ•°æ®é›†è¿æ¥æ“ä½œå‡½æ•°ï¼Œä¾‹å¦‚ `left_join()` å¯è§†ä¸º `nest_join() + unnest(.keep_empty = TRUE)`ï¼Œ`semi_join()` å¯è§†ä¸º `nest_join() + filter()`ï¼ˆ`filter()`ç”¨æ¥æ£€æŸ¥åˆ—è¡¨åˆ—ä¸­å…ƒç´ æ˜¯å¦ä¸º0è¡Œçš„`tibble`ï¼‰
]

]

--

.pull-right[

.full-width.content-box-blue.bold.font120[ç”¨ `y` è¡¨ä¸­çš„æ•°æ®æ¥ä¿®æ”¹ `x` è¡¨ä¸­çš„è¡Œ]

.font100[

* `rows_insert(x, y, by = NULL, ...)` | `rows_update()` | `rows_upsert()`
* `rows_delete()`
* `rows_append()` | `rows_patch()`
]

.full-width.content-box-blue.bold.font120[åˆå¹¶å¤šä¸ªæ•°æ®é›†çš„è¡Œæˆ–åˆ—]

.font100[
* `bind_rows(..., .id = NULL)` &lt;br&gt; `# do.call(rbind, dfs_list)`
* `bind_cols(..., .name_repair)` &lt;br&gt; `# do.call(cbind, dfs_list)`
]

.full-width.content-box-blue.bold.font120[é›†åˆå¼åˆå¹¶]

.font100[
* `intersect(x, y, ...)`
* `setdiff(x, y, ...)` | `symdiff()`
* `union(x, y, ...)` | `union_all()`
]

]

---
layout: false
class: inverse, center, middle

# 7. æ“ä½œæ•°æ®åº“å’Œ `data.table`

---
layout: true
background-image: url(imgs/logo-dbplyr.png)
background-size: 4%
background-position: 35% 3%

### &gt;&gt; è¿æ¥å¹¶æŸ¥è¯¢æ•°æ®åº“

---

.pull-left.font120[

é™¤äº†å¤„ç†å†…å­˜ä¸­ä»¥ `tibble` æˆ– `data.frame` æ ¼å¼å­˜åœ¨çš„æ•°æ®é›†ä¹‹å¤–ï¼Œdplyr åŒ…è¿˜å¯ç”¨äºå¤„ç†å­˜å‚¨åœ¨ä¸»æµæ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œè¿™ä¸»è¦é€‚ç”¨äºä¸¤ç§æƒ…å½¢ï¼š
- æ•°æ®å·²ç»å­˜å‚¨åœ¨æ•°æ®åº“ä¸­
- æ•°æ®å¤ªå¤§æ— æ³•ç›´æ¥å­˜å…¥å†…å­˜ä¸­ï¼Œå¿…é¡»ä½¿ç”¨å¤–éƒ¨å­˜å‚¨

è¿™éœ€è¦ä½ é¢å¤–å®‰è£… dbplyr åŒ…&lt;sup&gt;2.3.4&lt;/sup&gt;ï¼ˆä¼šè‡ªåŠ¨å®‰è£…å…¶éœ€è¦è½½å…¥çš„ `DBI` åŒ…ï¼‰ä»¥åŠä½ æ‰“ç®—è¿æ¥çš„ä¸åŒæ•°æ®åº“çš„æ¥å£ R åŒ…ï¼ˆå¦‚ `RPostgres`ã€`RMariaDB`ã€`odbc` ç­‰ï¼‰ã€‚  
  
ä»¥ä¸‹æˆ‘ä»¬ä»¥`SQLite`æ•°æ®åº“ä¸ºä¾‹è¯´æ˜ã€‚

]

--

.pull-right[

.full-width[.content-box-blue.bold.font120[å‡†å¤‡å·¥ä½œ]]

```r
# install.packages("dbplyr")
# install.packages("RSQLite")
```


```r
# library(dplyr)
con &lt;- DBI::dbConnect(
         RSQLite::SQLite(), 
         dbname = ":memory:"
       )

copy_to(
  con, 
  nycflights13::flights, 
  "flights", 
  overwrite = TRUE,
  indexes = list(
    c("year", "month", "day"), 
    "carrier", "tailnum", "dest")
)
```

]

---


```r
# åˆ›å»ºå¯¹æ•°æ®è¡¨çš„å¼•ç”¨å¹¶åˆ—å°ç»“æœ
(flights_db &lt;- tbl(con, "flights"))
```

```
*#&gt; # Source:   table&lt;flights&gt; [?? x 19]
*#&gt; # Database: sqlite 3.41.2 [:memory:]
#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
#&gt; 1  2013     1     1      517            515         2      830            819
#&gt; 2  2013     1     1      533            529         4      850            830
#&gt; 3  2013     1     1      542            540         2      923            850
#&gt; # â„¹ more rows
#&gt; # â„¹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#&gt; #   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#&gt; #   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dbl&gt;
```

```r
# ç”ŸæˆæŸ¥è¯¢
tailnum_delay_db &lt;- flights_db %&gt;% 
  group_by(tailnum) %&gt;%
  summarise(
    delay = mean(arr_delay), n = n()
  ) %&gt;% 
  arrange(desc(delay)) %&gt;% filter(n &gt; 100)
```

---


```r
tailnum_delay_db %&gt;% 
* show_query()
```

```
#&gt; &lt;SQL&gt;
#&gt; SELECT `tailnum`, AVG(`arr_delay`) AS `delay`, COUNT(*) AS `n`
#&gt; FROM `flights`
#&gt; GROUP BY `tailnum`
#&gt; HAVING (COUNT(*) &gt; 100.0)
#&gt; ORDER BY `delay` DESC
```


```r
tailnum_delay &lt;- tailnum_delay_db %&gt;% 
* collect()
tailnum_delay
```

```
*#&gt; # A tibble: 1,201 Ã— 3
#&gt;   tailnum delay     n
#&gt;   &lt;chr&gt;   &lt;dbl&gt; &lt;int&gt;
#&gt; 1 N11119   30.3   148
#&gt; 2 N16919   29.9   251
#&gt; 3 N14998   27.9   230
#&gt; # â„¹ 1,198 more rows
```

---
layout: true
background-image: url(imgs/logo-dtplyr.png)
background-size: 4%
background-position: 34% 3%

### &gt;&gt; æ“ä½œ `data.table`

---

.pull-left.font110[

`data.table` æ˜¯ data.table åŒ…æä¾›çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œæ˜¯å‡çº§ç‰ˆçš„ `data.frame`ï¼š
- ç®€æ´çš„è¯­æ³•ï¼Œ`x[i, j, by]`
- æ—¶é—´/å†…å­˜é«˜æ•ˆçš„æ•°æ®æ“ä½œï¼Œå¦‚æ–‡ä»¶è¯»å–/è¾“å‡ºã€æ•°æ®æå–ã€æ±‡æ€»ã€æ›´æ–°ã€åˆå¹¶ç­‰
- å…¼å®¹åªæ¥å— `data.frame` æ•°æ®æ ¼å¼çš„å…¶å®ƒ R åŒ…

dplyr åŒ…å…è®¸ä½ ä»¥ dplyr çš„æ–¹å¼æ“ä½œ `data.table`ï¼Œåå°çš„ dtplyr åŒ…&lt;sup&gt;1.3.1&lt;/sup&gt;ä¼šè‡ªåŠ¨å°†å…¶è½¬è¯‘ä¸ºç­‰ä»·çš„ `data.table` è¯­æ³•ã€‚

]

--

.pull-right.code70[


```r
# install.packages("dtplyr")
library(dtplyr)
# library(data.table)
library(dplyr, warn.conflicts = FALSE)
```


```r
# åˆ›å»ºä¸€ä¸ªlazy data.tableï¼Œè¿½è¸ªå¯¹å…¶çš„æ“ä½œ
flights_dt &lt;- lazy_dt(nycflights13::flights)
# æ“ä½œdata.table
flights_dt %&gt;% 
  mutate(arr_delay = arr_delay/60) %&gt;% 
  group_by(tailnum) %&gt;% 
  summarize(
    across(ends_with("_delay"), mean), n = n()
  ) %&gt;% 
  arrange(desc(arr_delay)) %&gt;% 
  filter(n &gt; 100)

# Use as.data.table()/as.data.frame()/
# as_tibble() to access results
```

]

.code70[

```
*#&gt; Source: local data table [1,201 x 4]
*#&gt; Call:   setorder(copy(`_DT1`)[, `:=`(arr_delay = arr_delay/60)][, .(dep_delay = mean(dep_delay), 
*#&gt;     arr_delay = mean(arr_delay), n = .N), keyby = .(tailnum)], 
*#&gt;     -arr_delay, na.last = TRUE)[n &gt; 100]
#&gt; 
#&gt;   tailnum dep_delay arr_delay     n
#&gt;   &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt; &lt;int&gt;
#&gt; 1 N826UA       26.7     0.326   120
#&gt; 2 N929DL       25.3     0.293   108
#&gt; 3 N431UA       23.9     0.272   104
#&gt; 4 N342NW       21.1     0.267   111
#&gt; 5 N567UA       18.7     0.250   105
#&gt; 6 N850UA       23.9     0.248   130
#&gt; # â„¹ 1,195 more rows
#&gt; 
*#&gt; # Use as.data.table()/as.data.frame()/as_tibble() to access results
```
]

---
layout: false
class: hide_logo
background-image: url(imgs/logo-siuba.svg)
background-size: 5%
background-position: 5% 3%

### &amp;emsp;&amp;emsp;`siuba`.font90[: Python library for using dplyr like syntax with pandas and SQL]

&lt;iframe src="https://siuba.org/" width="100%" height="540px" data-external="1"&gt;&lt;/iframe&gt;

---
layout: false
class: hide_logo
background-image: url(imgs/logo-ibis.svg)
background-size: 5%
background-position: 5% 3%

### &amp;emsp;&amp;emsp;`ibis`.font90[: a lightweight, universal Python interface for data wrangling]

&lt;iframe src="https://ibis-project.org/tutorials/ibis-for-dplyr-users" width="100%" height="540px" data-external="1"&gt;&lt;/iframe&gt;

---
layout: false
class: inverse, center, middle

# è¯¾åå¤ä¹ 

---
class: middle

.font130[

ğŸ• å­¦ä¹  ğŸ“ [**{{MarkdownåŸºç¡€}}**](https://qfwr2023.netlify.app/readings/markdown-basics) å’Œ [**{{Revealjs æ¼”ç¤ºæ–‡ç¨¿}}**](https://qfwr2023.netlify.app/readings/revealjs)ï¼Œ**å®Œå–„[ç¬¬4å‘¨çš„è¯¾åä½œä¸š](https://qfwr2023.netlify.app/hw/hw-03)**ï¼Œå¹¶å¢åŠ éƒ¨åˆ†ç¯‡å¹…è¯´æ˜å…·ä½“æ”¹è¿›ä¹‹å¤„ï¼Œäº**2023å¹´10æœˆ26æ—¥22:00å‰**å°†å‹ç¼©åŒ…æäº¤è‡³ [{{åšæœäº‘é“¾æ¥}}](https://send2me.cn/rAnWP-yK/RjqyWTleU7stqA)

ğŸ•‘ å¤ä¹  ğŸ“– [**{{_R for Data Science, 2e_}}**](https://r4ds.had.nz/) ä¸€ä¹¦ç¬¬ä¸‰éƒ¨åˆ† _Transform_ ä¸­å…³äºè¿æ¥æ•°æ®é›†çš„ç« èŠ‚ï¼Œå³ [**20 Joins**](https://r4ds.hadley.nz/joins) å¹¶**ï¼ˆç»“é˜Ÿï¼‰å®Œæˆè¯¾åç»ƒä¹ **
  &gt; ğŸ‘‰ ~~è¯¾åä¹ é¢˜å‚è€ƒç­”æ¡ˆé“¾æ¥~~&lt;br&gt;
  &gt; &amp;emsp; [~~{{R for Data Science (2e): Solutions to Exercises}}~~](https://mine-cetinkaya-rundel.github.io/r4ds-solutions/joins.html) &lt;br&gt;
  &gt; &amp;emsp; [{{R for Data Science: Exercise Solutions}}](https://jrnold.github.io/r4ds-exercise-solutions/relational-data.html)

ğŸ•’ ä¸‹è½½ï¼ˆæ‰“å°ï¼‰ ğŸ“° [**{{dplyrçš„cheatsheet}}**](docs/dplyr-cheatsheet.pdf) å¹¶é˜…è¯»ä¹‹

ğŸ•“ `browseVignettes(package = "dplyr")` ğŸ“ï¼Œé˜…è¯»ï¼š

&gt; .code80[

```
Row-wise operations
Two-table verbs
```
]

]

---
class: center, middle, hide_logo
background-image: url(imgs/xaringan.png)
background-size: 12%
background-position: 50% 40%

&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;
&lt;hr color='#f00' size='2px' width='80%'&gt;
&lt;br&gt;
.Large.red[_**æœ¬ç½‘é¡µç‰ˆè®²ä¹‰çš„åˆ¶ä½œç”± R åŒ… [{{`xaringan`}}](https://github.com/yihui/xaringan) èµ‹èƒ½ï¼**_]

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="../libs/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
